{% extends "manage/base.html" %}

{% load django_bootstrap5 %}


{% block title %}
Add/Edit UserProfile Group
{% endblock %}

{% block content %}
<a class="btn btn-dark btn-sm" href="{% url 'manage_userprofile_group_list' %}">
    <i class="fa fa-arrow-left"></i>
    Back to Listing
</a>

<form class="form-content" action="" enctype="multipart/form-data" method="post">
    {% csrf_token %}

    {% bootstrap_form form  size='sm' field_class="p-1 mb-3" %}
    {% bootstrap_button 'Save' button_class="btn-success" extra_classes=" stopresent mb-3" %}

</form>

{% if object.pk %}
<form action="" enctype="multipart/form-data" method="post">

    <div class="csrf_token">
        {% csrf_token %}
    </div>

    <div class="row">
        {% for app in apps %}
        <div class="col-sm-12">
            <h3 class="text-center bg-light">{{ app.name }}</h3>
        </div>

        {% for module in app.modules %}
        <div class="col-sm-3">
            <h5>{{ module.name }}</h5>

            {% for permission in module.permissions %}
            <div class="form-check">
                <input type="checkbox" value="{{ app.name }}:{{ module.name }}:{{ permission.codename }}"
                    class="form-check-input" id="{{ app.name }}_{{ module.name }}_{{ permission.codename }}"
                    {% if permission in group_permissions %} checked {% endif %}>
                <label class="form-check-label"
                    for="{{ app.name }}_{{ module.name }}_{{ permission.codename }}">{{ permission.name }}</label>
            </div>

            {% endfor %}
        </div>
        {% endfor %}

        {% endfor %}
    </div>

    {% bootstrap_button 'Save' button_class="btn-success" extra_classes=" stopresent mb-3" %}

    <input class="group_id" type="hidden" name="group_id" value="{{ object.id }}" />

</form>

<script>
    var action = 'add'
    var group_id = $('.group_id').val()
    var csrfmiddlewaretoken = $('.csrf_token input').val()

    $('input:checkbox').change(function () {

        var permission_str = $(this).val()

        if (this.checked)
            action = 'add'
        else
            action = 'remove'

        $.ajax({
                method: "POST",
                url: "{% url 'manage_change_group_permissions' %}",
                data: {
                    'group_id': group_id,
                    'action': action,
                    'permission': permission_str,
                    'csrfmiddlewaretoken': csrfmiddlewaretoken,
                }
            })
            .done(function (msg) {
                console.log(msg);
            })
            .fail(function (xhr, err) {
                var responseTitle = $(xhr.responseText).filter('title').get(0);
                alert($(responseTitle).text() + "\n" + formatErrorMessage(xhr, err));
            });
    });

    function formatErrorMessage(jqXHR, exception) {

        if (jqXHR.status === 0) {
            return ('Not connected.\nPlease verify your network connection.');
        } else if (jqXHR.status == 404) {
            return ('The requested page not found. [404]');
        } else if (jqXHR.status == 500) {
            return ('Internal Server Error [500].');
        } else if (exception === 'parsererror') {
            return ('Requested JSON parse failed.');
        } else if (exception === 'timeout') {
            return ('Time out error.');
        } else if (exception === 'abort') {
            return ('Ajax request aborted.');
        } else {
            return ('Uncaught Error.\n' + jqXHR.responseText);
        }
    }
</script>

{% endif %}
{% endblock %}